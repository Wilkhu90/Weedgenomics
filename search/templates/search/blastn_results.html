{% extends "search/blastn_search.html" %}

{% load staticfiles %}

{% block results %}
    <div class="row">
      <div class="col-xs-12">
        <h4>Search Results for Sequence: "{{searchQuery.query}}" and Species: "{{searchQuery.species|title}}"</h4>
      </div>
    </div>
    {% if hits %}

    {% for result in hits %}
    <table class="table table-striped table-bordered">
      <thead class="thead-inverse">
        <tr>
          <th>{{forloop.counter}}. <a href="{% url 'search:download_fasta' result.ID %}">Download  <img src= "{% static 'search/images/download.png' %}" width="40" height="40" /></a></th>
        </tr>
      </thead>
        <tbody>
        <tr>
          <td>
            <h4>Description: {{result.description|title}}</h4>
            <div class="row">
              <div class="col-xs-6">
                <h4>Sequence ID: {{result.Hit_id}}</h4>
              </div>
              <div class="col-xs-3">
                <h4>Length: {{result.length}}</h4>
              </div>
              <div class="col-xs-3">
                <h4>Threshold Exp: {{result.Hit_exp}}</h4>
              </div>
            </div>
            {% for res in result.new_seq %}
            <div class="row">
              <div class="col-xs-2">
                Query
              </div>
              <div class="col-xs-10">
                <p class="stretch">{{res.Hit_query}}</p>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-2">
                Match (<span class="mismatch"></span>)
              </div>
              <div class="col-xs-10">
                <p class="stretch match">{{res.Hit_match}}</p>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-2">
                Subject
              </div>
              <div class="col-xs-10">
                <p class="stretch">{{res.Hit_sbject}}</p>
              </div>
            </div>
            {% endfor %}
          </td>
        </tr>
        </tbody>
    </table>
    <script>
    $.fn.strech_text = function(){
      var elmt          = $(this),
          cont_width    = elmt.width(),
          txt           = elmt.html().replace(/ /g, 'X').replace(/\|/g, '-'),
          one_line      = $('<span class="stretch_it">' + txt + '</span>'),
          nb_char       = elmt.text().length,
          spacing       = cont_width/nb_char,
          txt_width;
      elmt.html(one_line);
      txt_width = one_line.width();

      if (txt_width < cont_width){
          var  char_width     = txt_width/nb_char,
               ltr_spacing    = spacing - char_width + (spacing - char_width)/nb_char ;

          one_line.css({'letter-spacing': ltr_spacing});
      } else {
          one_line.contents().unwrap();
          elmt.addClass('justify');
      }
    };


    $(document).ready(function () {
      $('.stretch').each(function(){
          $(this).strech_text();
      });
      $('.stretch.match').each(function(){
          var txt = $(this).text();
          var den = txt.split('').length;
          var num = txt.split('-').length-1;
          if(den != 0) {
            console.log((num/den*100).toFixed(2)+'%');
            console.log($(this).parent().parent().children()[0].children[0]);
            var match = $(this).parent().parent().children()[0].children[0];
            match.innerHTML = (num/den*100).toFixed(2)+'%';
          }
      });
    });
    </script>
    <br/>
    {% endfor %}

    {% else %}
    <h4> No results found </h4>
    {% endif %}

{% endblock %}
